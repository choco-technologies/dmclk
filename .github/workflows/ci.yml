name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop, 'feature/**', 'copilot/**' ]

jobs:
  discover-cpu-families:
    name: Discover CPU Families
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      cpu_families: ${{ steps.list-families.outputs.cpu_families }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: List available CPU families
        id: list-families
        run: |
          # Find all CPU families by looking for directories containing port.c
          CPU_FAMILIES=$(find src/port -mindepth 2 -maxdepth 2 -name "port.c" -type f -printf '%h\n' | \
            xargs -n1 basename | \
            sort | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "Found CPU families: $CPU_FAMILIES"
          echo "cpu_families=$CPU_FAMILIES" >> $GITHUB_OUTPUT

  build-dmclk:
    name: Build dmclk for ${{ matrix.cpu_family }}
    needs: discover-cpu-families
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        cpu_family: ${{ fromJson(needs.discover-cpu-families.outputs.cpu_families) }}
    
    container:
      image: chocotechnologies/dmod:1.0.4
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build dmclk for ${{ matrix.cpu_family }}
        run: |
          set -e
          CPU_FAMILY="${{ matrix.cpu_family }}"
          mkdir -p build_$CPU_FAMILY
          cd build_$CPU_FAMILY
          
          cmake .. -DDMCLK_MCU_SERIES="${CPU_FAMILY}"
          cmake --build . 
          
          echo "Build completed for CPU family: ${CPU_FAMILY}"
          ls -lh dmf/

      - name: Verify dmclk_port module files
        run: |
          CPU_FAMILY="${{ matrix.cpu_family }}"
          echo "Checking for dmclk_port module files for ${CPU_FAMILY}..."
          ls -lh build_$CPU_FAMILY/dmf/
          test -f build_$CPU_FAMILY/dmf/dmclk_port.dmf
          test -f build_$CPU_FAMILY/dmf/dmclk_port_version.txt
          echo "Module files present for ${CPU_FAMILY}"
