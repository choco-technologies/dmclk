name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop, 'feature/**', 'copilot/**' ]

jobs:
  discover-cpu-families:
    name: Discover CPU Families
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      cpu_families: ${{ steps.list-families.outputs.cpu_families }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: List available CPU families
        id: list-families
        run: |
          # Find all directories in src/port/ excluding stm32_common and other non-family directories
          CPU_FAMILIES=$(find src/port -mindepth 1 -maxdepth 1 -type d \
            ! -name "stm32_common" \
            -exec basename {} \; | \
            sort | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "Found CPU families: $CPU_FAMILIES"
          echo "cpu_families=$CPU_FAMILIES" >> $GITHUB_OUTPUT

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: chocotechnologies/dmod:1.0.4
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build dmclk project
        run: |
          mkdir -p build
          cd build
          cmake .. -DDMOD_MODE=DMOD_MODULE
          cmake --build .
      
      - name: Verify module files
        run: |
          echo "Checking for module files..."
          ls -lh build/dmf/
          test -f build/dmf/dmclk.dmf
          test -f build/dmf/dmclk_version.txt
          echo "Module files present"

  build-dmclk-port:
    name: Build dmclk_port for ${{ matrix.cpu_family }}
    needs: discover-cpu-families
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        cpu_family: ${{ fromJson(needs.discover-cpu-families.outputs.cpu_families) }}
        include:
          # Map CPU families to their typical architectures
          - cpu_family: stm32f4
            arch_name: armv7/cortex-m4
          - cpu_family: stm32f7
            arch_name: armv7/cortex-m7
    
    container:
      image: chocotechnologies/dmod:1.0.4
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build dmclk_port for ${{ matrix.cpu_family }}
        run: |
          set -e
          CPU_FAMILY="${{ matrix.cpu_family }}"
          mkdir -p build_$CPU_FAMILY
          cd build_$CPU_FAMILY
          
          # Build dmclk_port with specific CPU family
          cmake .. \
            -DDMOD_MODE=DMOD_MODULE \
            -DDMOD_TOOLS_NAME=arch/${{ matrix.arch_name }} \
            -DDMCLK_MCU_SERIES="${CPU_FAMILY}"
          
          # Build only the dmclk_port module
          cmake --build . --target dmclk_port
          
          echo "Build completed for CPU family: ${CPU_FAMILY}"
          ls -lh dmf/
      
      - name: Verify dmclk_port module files
        run: |
          CPU_FAMILY="${{ matrix.cpu_family }}"
          echo "Checking for dmclk_port module files for ${CPU_FAMILY}..."
          ls -lh build_$CPU_FAMILY/dmf/
          test -f build_$CPU_FAMILY/dmf/dmclk_port.dmf
          test -f build_$CPU_FAMILY/dmf/dmclk_port_version.txt
          echo "Module files present for ${CPU_FAMILY}"

      
